<!DOCTYPE html>
<html>
<head>
    <title>Application List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        table {
            width: 80%;
            margin: auto;
        }
        th, td {
            padding: 10px;
            vertical-align: top;
	    text-align: center;
        }
    </style>
    <script defer>
    function fetchWhatis(mod, version) {
        const url = `{{ url_for('module_whatis') }}?mod=${encodeURIComponent(mod)}&version=${encodeURIComponent(version)}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.info) {
                    document.getElementById("whatisModalLabel").innerText = `${mod}/${version}`;
                    document.getElementById("whatisModalBody").innerHTML = linkify(data.info);
                    let modal = new bootstrap.Modal(document.getElementById('whatisModal'));
                    modal.show();
                } else {
                    alert("No info found.");
                }
            });
    }
    function linkify(text) {
        text = text.replaceAll(/"(?=\s|$)/g, '');
        const urlRegex = /(https?:\/\/[^\s"]+)/g;
        return text.replace(urlRegex, function(url) {
            return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
        });
    }
let appNames = Array.from(new Set([
  {% for pkg in packages %}
  "{{ pkg.name }}",
  {% endfor %}
])).sort();

function updateSuggestions() {
    const input = document.getElementById("searchBox");
    const list = document.getElementById("suggestionList");
    const query = input.value.toLowerCase();

    list.innerHTML = "";
    if (!query) {
        list.style.display = "none";
        return;
    }

    const matches = appNames.filter(name => name.toLowerCase().includes(query));

    matches.forEach(name => {
        const li = document.createElement("li");
        li.className = "list-group-item list-group-item-action";
        li.textContent = name;
        li.onclick = () => {
            input.value = name;
            list.style.display = "none";
        };
        list.appendChild(li);
    });

    list.style.display = matches.length > 0 ? "block" : "none";
}

function handleKeydown(event) {
    const list = document.getElementById("suggestionList");
    if (event.key === "Escape") list.style.display = "none";
}

function scrollToApp() {
    const target = document.getElementById("searchBox").value.toLowerCase();
    const rows = document.querySelectorAll("table tr");
    let found = false;

    for (let i = 1; i < rows.length; i++) {
        const name = rows[i].cells[0].innerText.toLowerCase();
        if (name === target) {
            rows[i].classList.add("table-warning");
            rows[i].scrollIntoView({ behavior: "smooth", block: "center" });
            found = true;
        } else {
            rows[i].classList.remove("table-warning");
        }
    }

    if (!found && target.trim() !== "") {
        alert("No exact match found.");
    }
}
    </script>
</head>
<body>
    <h2 class="text-center mt-4 mb-4 fw-bold">Application List</h2>
<p class="text-center text-muted mb-4" style="max-width: 800px; margin: 0 auto;">
  This page displays all <strong>available modules</strong> from the <strong>EESSI 2023.06</strong> stack.
  You can <strong>click a version</strong> to view module details, or <strong>search by application name</strong> to jump to it.
  Use the <strong>Top</strong> button at the bottom right to quickly return to the top of the page.
</p>
<div class="container mb-4" style="position: relative; max-width: 400px;">
  <div class="input-group">
    <input type="text" id="searchBox" class="form-control" placeholder="Search application name..." oninput="updateSuggestions()" onkeydown="handleKeydown(event)">
    <button class="btn btn-primary" onclick="scrollToApp()">Go</button>
  </div>
  <ul id="suggestionList" class="list-group position-absolute w-100 shadow" style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;"></ul>
</div>


    {% if error %}
        <p style="color:red; text-align:center;">Error: {{ error }}</p>
    {% endif %}

    <table class="table table-striped table-bordered table-hover mt-4">
        <tr>
            <th>Name</th>
            <th>Version</th>
        </tr>
        {% for pkg in packages %}
        <tr>
            <td>{{ pkg.name }}</td>
	    <td><a class="text-primary text-decoration-none" href="#" onclick="fetchWhatis('{{ pkg.name }}', '{{ pkg.version }}'); return false;" title="Show module info">{{ pkg.version }}</a></td>
        </tr>
        {% endfor %}
    </table>
	<div class="modal fade" id="whatisModal" tabindex="-1" aria-labelledby="whatisModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-lg modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="whatisModalLabel"></h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body">
	        <div id="whatisModalBody" style="white-space: pre-wrap; font-family: monospace;"></div>
	      </div>
	    </div>
	  </div>
	</div>
<button onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
        class="btn btn-secondary position-fixed bottom-0 end-0 m-3">
  â†‘ Top
</button>

</body>
</html>
